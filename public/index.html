<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
    <script src="js/extensions.js"></script>
  </head>
  <body>
    <div id="mocha">
      <div class="suite">
        <h2>
          Run <a href="?manual=1">manually</a> or
          <a href="?manual=0">automatically</a>
        </h2>
        <h2>
          <a target="_blank" href="https://github.com/jinjor/elm-break-dom"
            >Source (GitHub)</a
          >
        </h2>
      </div>
    </div>
    <script src="https://unpkg.com/mocha/mocha.js"></script>
    <script class="mocha-init">
      mocha.setup("bdd");
      mocha.checkLeaks();
    </script>
    <script>
      describe("Extentions", function() {
        this.slow(1000);
        let error;
        let successful = true;
        before(function() {
          window.onerror = function(e) {
            error = e;
          };
        });
        describe("Grammarly", function() {
          it("1", async function() {
            document.querySelector("#textarea1 button").click();
            await new Promise(resolve => setTimeout(resolve, 100));
            if (error) {
              throw error;
            }
          });
          it("2", async function() {
            document.querySelector("#textarea2 button").click();
            await new Promise(resolve => setTimeout(resolve, 100));
            if (error) {
              throw error;
            }
          });
          it("3", async function() {
            document.querySelector("#textarea3 button").click();
            await new Promise(resolve => setTimeout(resolve, 100));
            if (error) {
              throw error;
            }
            if (document.querySelector("#textarea3 textarea.before")) {
              throw new Error(`found: textarea.before`);
            }
            if (!document.querySelector("#textarea3 textarea.after")) {
              throw new Error("not found: textarea.after");
            }
          });
          afterEach(function() {
            if (!document.getElementsByTagName("grammarly-extension").length) {
              console.log("WARN: Grammarly has not been tested.");
            }
          });
        });
        describe("Another Extensions", function() {
          it("should also be tested here", async function() {});
        });
        afterEach(function() {
          if (error) {
            throw new Error("Unable to continue tests");
          }
          if (this.currentTest.state === "failed") {
            successful = false;
          }
        });
        after(function() {
          if (window.done) {
            window.done(successful);
          }
        });
      });
    </script>
    <script class="mocha-exec">
      if (new URLSearchParams(location.search).get("manual") !== "1") {
        mocha.run();
      }
    </script>

    <hr />
    <!------------------------------------------------------------------------>

    <div id="root"></div>
    <script>
      const app = Elm.Extensions.init({
        node: document.getElementById("root")
      });
      app.ports.focusTextarea.subscribe(id => {
        const textarea = document.querySelector(`#${id} textarea`);
        textarea.focus();
        setTimeout(() => {
          textarea.blur();
          app.ports.done.send(id);
        }, 30);
      });
    </script>
  </body>
</html>
