<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
  </head>
  <body>
    <script src="https://unpkg.com/mocha/mocha.js"></script>
    <script></script>

    <div id="root"></div>
    <script>
      const patchMode =
        new URLSearchParams(location.search).get("src") === "patched";
      const elementMode =
        new URLSearchParams(location.search).get("main") === "element";
      const manualMode =
        new URLSearchParams(location.search).get("test") === "manual";

      (async () => {
        const src = patchMode ? "js/extensions-patched.js" : "js/extensions.js";
        await requireScript(src);
        initElm();
        await new Promise(resolve => setTimeout(resolve, 100));
        runMocha();
      })();

      function requireScript(src) {
        return new Promise((resolve, reject) => {
          if (document.querySelector(`script[src="${src}"]`)) {
            return resolve();
          }
          const script = document.createElement("script");
          script.src = src;
          document.head.appendChild(script);
          script.onload = function() {
            resolve();
          };
          script.onerror = function(e) {
            reject(new Error("Failed to load " + src));
          };
        });
      }
      function initElm() {
        const main = elementMode ? Elm.Element : Elm.Application;
        const app = main.init({
          node: document.getElementById("root")
        });
        app.ports.focusTextarea.subscribe(id => {
          const textarea = document.querySelector(`#${id} textarea`);
          textarea.focus();
          setTimeout(() => {
            textarea.blur();
            app.ports.done.send(id);
          }, 30);
        });
      }
      function runMocha() {
        mocha.setup("bdd");
        describe("Extentions", function() {
          this.slow(1000);
          let error;
          let successful = true;
          before(function() {
            window.onerror = function(e) {
              error = e;
            };
          });
          describe("Load this page", function() {
            it("should load this page without errors", async function() {
              if (error) {
                throw error;
              }
            });
          });
          describe("First update (for ChromeVox or Viber)", function() {
            it("should update dom after inserting element", async function() {
              await new Promise(resolve => setTimeout(resolve, 100)); // wait for inserting ChromeVox
              document.querySelector("#update button").click();
              await new Promise(resolve => setTimeout(resolve, 100));
              if (error) {
                throw error;
              }
            });
          });
          describe("Grammarly", function() {
            it("should update dom after focusing on textarea 1", async function() {
              document.querySelector("#textarea1 button").click();
              await new Promise(resolve => setTimeout(resolve, 100));
              if (error) {
                throw error;
              }
            });
            it("should update dom after focusing on textarea 2", async function() {
              document.querySelector("#textarea2 button").click();
              await new Promise(resolve => setTimeout(resolve, 100));
              if (error) {
                throw error;
              }
            });
            it("should update dom after focusing on textarea 3", async function() {
              document.querySelector("#textarea3 button").click();
              await new Promise(resolve => setTimeout(resolve, 100));
              if (error) {
                throw error;
              }
              if (document.querySelector("#textarea3 textarea.before")) {
                throw new Error(`found: textarea.before`);
              }
              if (!document.querySelector("#textarea3 textarea.after")) {
                throw new Error("not found: textarea.after");
              }
            });
          });
          afterEach(function() {
            if (error) {
              throw new Error("Unable to continue tests");
            }
            if (this.currentTest.state === "failed") {
              successful = false;
            }
          });
          after(function() {
            if (window.done) {
              window.done(successful);
            }
            console.log("done");
          });
        });
        if (!manualMode) {
          mocha.run();
        }
      }
    </script>
  </body>
</html>
