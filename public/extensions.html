<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
    <script src="js/extensions.js"></script>
  </head>
  <body>
    <div id="mocha"></div>
    <script src="https://unpkg.com/mocha/mocha.js"></script>
    <script class="mocha-init">
      mocha.setup("bdd");
      mocha.checkLeaks();
    </script>
    <script>
      describe("Extentions", function() {
        this.slow(1000);
        let error;
        before(function() {
          window.onerror = function(e) {
            error = e;
          };
        });
        describe("Grammarly", function() {
          it("1", async function() {
            document.querySelector("#textarea1 button").click();
            await new Promise(resolve => setTimeout(resolve, 100));
            if (error) {
              throw error;
            }
          });
          it("2", async function() {
            document.querySelector("#textarea2 button").click();
            await new Promise(resolve => setTimeout(resolve, 100));
            if (error) {
              throw error;
            }
          });
          it("3", async function() {
            document.querySelector("#textarea3 button").click();
            await new Promise(resolve => setTimeout(resolve, 100));
            if (error) {
              throw error;
            }
            if (document.querySelector("#textarea3 .child.before")) {
              throw new Error(`found: .child.before`);
            }
            if (!document.querySelector("#textarea3 .child.after")) {
              throw new Error("not found: .child.after");
            }
          });
          afterEach(function() {
            if (!document.getElementsByTagName("grammarly-extension").length) {
              console.log("WARN: Grammarly has not been tested.");
            }
          });
        });
        describe("Another", function() {
          it("works", async function() {});
        });
        afterEach(function() {
          if (error) {
            throw new Error("Unable to continue tests");
          }
        });
      });
    </script>
    <script class="mocha-exec">
      mocha.run();
    </script>

    <hr />
    <!------------------------------------------------------------------------>

    <div id="root"></div>
    <script>
      const app = Elm.Extensions.init({
        node: document.getElementById("root")
      });
      app.ports.focusTextarea.subscribe(id => {
        const textarea = document.querySelector(`#${id} textarea`);
        textarea.focus();
        setTimeout(() => {
          textarea.blur();
          app.ports.done.send(id);
        }, 30);
      });
    </script>
  </body>
</html>
